# 系统架构概要

@greet guo

# 服务定义：

🕸 Trade Api/交易接口
收到请求后基于产品，账户，权限等配置参数进行静态风控、预埋单，延时成交单发给PBO成功后返回给客户、调价单通过静态风控后绑定清结算使用的参数之后把请求放到正确的MQ中、如果是只读类查询请求直接请求Clearing。

🔗 PreBuried Order(PBO)/预埋单
提供查询用户的挂单接口、如果价格或者时间触发则请求回Trade Api按市价继续走，此模块中不需要冻结，生成预埋单订单，维护订单状态，生成延时成交订单维护订单状态。

🤖 Trade/交易服务
按照单个用户的请求顺序逐个处理，这里只有市价单，先按过实时行情的价格风控，之后执行冻结，多冻结20%(可配)，冻结成功后生成订单，确定的订单发给clearing，clearing收到后返回给客户成功。所有的平仓先冻结仓位，冻结成功返回客户成功。接收到爆仓请求时则需要把预埋单与延时单取消掉。

🔎 Order/订单服务
插入新订单，更新order，提供order列表查询接口。

🧩 Clearing/清结算服务
执行撮合确定的订单，生成仓位、提供浮动盈亏接口（实时计算）、提供账户基本信息接口（Account）、提供账户实时信息接口（实时计算+Account）、出入金请求处理（资金管理服务直接调用）、各类强平、隔夜利息收取、仓位变更账户变更走消息通知（待讨论）、资金冻结接口、仓位冻结接口。

💻 Postion/持仓服务
插入新仓位、更新仓位、广播仓位数据、仓位列表接口、冻结仓位接口。

💡 Account/账户服务
记账、对账、开户，销户，冻结、账户基本信息接口。

📊 Real Time Calculate(RTC)/实时计算服务
保证金计算，爆仓发指令给CFD Trade、止盈止损平仓发指令给CFD Trade、提供浮动盈亏接口

🗃 Settlement/产品结息服务
产品到期强平发指令给Trade、结算时间到发指令给清结算

🏘 Config Service/参数配置服务
配置产品数据，账户组数据，负责持久化，负责提供配置信息的广播同步更新等，需要使用配置信息的其它服务订阅该服务，设计图在另一张图中《基础数据设计图》

🧠 Customer Service/开户KYC服务
客户开户、授权校验、KYC认证配置、KYC资料核心服务；提供KYC认证参数配置以及客户资料审核功能；同时提供客户资料基础查询以及数据导出等功能。

🔎 Fund Service/出入金服务
客户资金查询、充值入金、出金提案等核心服务；负责支付网关接入，不同支付方式配置以及基础支付参数设置；同时提供出入金记录查询以及数据导出等功能。

🧩 Meaasge Service/消息中心服务
负责站内信、短信、Email等消息对外发送接口

💻 Admin Service/平台管理服务
SAAS化后台管理，用户设置产品权限以及玩法配置，短信、Email、支付等相关基础配置功能；提供开白标公司，以及分配白标权限级别；白标可以配置自己的产品参数以及管理自己的客户数据和交易流程等数据。

🧩 name_server 

服务注册，为行情链路其他各服务提供服务发现

🧩 receive 

接收行情源数据，例如引入外部外汇数据源，进行协议转换

🧩 combo

将不同的产品的报价进行组合

🧩 蝴蝶MM

将报价按照蝴蝶算法进行修改

🧩 match-engine 

内部撮合引擎，成交后推送报价至market

🧩 market 

行情数据核心处理服务，依据后台的配置，进行报价转换

🧩 market-poxy 

行情数据转发代理服务，为交易路线的服务提供报价，为前置网关区域的服务提供行情报价

🧩 tickcatch 

最近行情tick数据缓存服务，按配置缓存最近N口成交报价

🧩 savetick、deep-savetick 

报价数据写到本地CSV的服务，方便排查问题时，查看报价的明细

🧩kline 

将自己负责范围内的symbol的成交报价，按照K线的计算规则，生成各周期的K线数据，并落地到DB里

提供自己负责范围内的symbol的K线查询

🧩kline_proxy

kline服务的代理，转发K线查询请求

🧩 rolling-calc 

24小时统计服务

🧩 quote 

行情对外接口服务，提供报价订阅推送，k线查询服务

🧩 tick-monitor 

行情数据链路报价推送监控服务

整体结构图：

![Untitled](%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A6%81/Untitled.png)

分层架构图：

![Untitled](%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A6%81/Untitled%201.png)

技术架构图：

![Untitled](%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A6%81/Untitled%202.png)

核心链路设计：

[行情数据链路设计](%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A6%81/%E8%A1%8C%E6%83%85%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E8%AE%BE%E8%AE%A1.md)

[合约交易链路设计](%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A6%81/%E5%90%88%E7%BA%A6%E4%BA%A4%E6%98%93%E9%93%BE%E8%B7%AF%E8%AE%BE%E8%AE%A1.md)